name: Delete Discord Message

on:
  workflow_dispatch:
    inputs:
      message_id:
        description: "Discord message ID to delete"
        required: true
      channel_id:
        description: "Channel/Thread ID (leave blank to use TDLBKGC_THREAD_ID secret)"
        required: false
        default: ""

jobs:
  delete:
    runs-on: ubuntu-latest
    env:
      DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
      INPUT_CHANNEL_ID: ${{ inputs.channel_id }}
      SECRET_THREAD_ID: ${{ secrets.TDLBKGC_THREAD_ID }}
      MESSAGE_ID: ${{ inputs.message_id }}
    steps:
      - name: Resolve CHANNEL_ID
        id: resolve
        run: |
          set -euo pipefail
          CHANNEL_ID="${INPUT_CHANNEL_ID}"
          if [ -z "$CHANNEL_ID" ]; then
            CHANNEL_ID="${SECRET_THREAD_ID}"
          fi

          # Basic validation (only digits)
          if ! printf '%s' "$CHANNEL_ID" | grep -Eq '^[0-9]{15,}$'; then
            echo "Bad CHANNEL_ID: '$CHANNEL_ID' (must be a numeric Snowflake, thread/channel ID)"
            exit 1
          fi
          if ! printf '%s' "$MESSAGE_ID" | grep -Eq '^[0-9]{15,}$'; then
            echo "Bad MESSAGE_ID: '$MESSAGE_ID' (must be a numeric Snowflake)"
            exit 1
          fi

          echo "channel_id=$CHANNEL_ID" >> "$GITHUB_OUTPUT"

      - name: Delete message via Discord API
        env:
          CHANNEL_ID: ${{ steps.resolve.outputs.channel_id }}
        run: |
          set -euo pipefail

          # Call API and capture body + status for debugging
          STATUS=$(curl -sS -X DELETE \
            -H "Authorization: Bot ${DISCORD_BOT_TOKEN}" \
            -H "Content-Type: application/json" \
            -o body.json -w "%{http_code}" \
            "https://discord.com/api/v10/channels/${CHANNEL_ID}/messages/${MESSAGE_ID}")

          echo "HTTP $STATUS"
          if [ "$STATUS" != "204" ]; then
            echo "Response body:"
            cat body.json || true
          fi

          case "$STATUS" in
            204) echo "üóëÔ∏è Deleted message ${MESSAGE_ID} in ${CHANNEL_ID}";;
            400) echo "‚ùå 400 Bad Request ‚Äî check you used the *thread* ID, not the parent channel ID, and IDs are numeric." ; exit 1;;
            403) echo "‚õî 403 Forbidden ‚Äî bot lacks permission (needs Manage Messages if it didn‚Äôt author the message)." ; exit 1;;
            404) echo "‚ùì 404 Not Found ‚Äî wrong channel/thread or message already gone." ; exit 1;;
            *)   echo "‚ö†Ô∏è Unexpected HTTP $STATUS"; exit 1;;
          esac
