name: Delete Discord Messages

on:
  workflow_dispatch:
    inputs:
      message_ids:
        description: "Comma-separated Discord message IDs to delete (e.g. 111,222,333)"
        required: true
      channel_id:
        description: "Channel/Thread ID (leave blank to use TDLBKGC_THREAD_ID secret)"
        required: false
        default: ""

jobs:
  delete:
    runs-on: ubuntu-latest
    env:
      DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
      INPUT_CHANNEL_ID: ${{ inputs.channel_id }}
      SECRET_THREAD_ID: ${{ secrets.TDLBKGC_THREAD_ID }}
      MESSAGE_IDS: ${{ inputs.message_ids }}

    steps:
      - name: Resolve CHANNEL_ID
        id: resolve
        run: |
          set -euo pipefail

          CHANNEL_ID="${INPUT_CHANNEL_ID}"
          if [ -z "$CHANNEL_ID" ]; then
            CHANNEL_ID="${SECRET_THREAD_ID}"
          fi

          # Basic validation (only digits)
          if ! printf '%s\n' "$CHANNEL_ID" | grep -Eq '^[0-9]{15,}$'; then
            echo "Bad CHANNEL_ID: '$CHANNEL_ID' (must be a numeric Snowflake, thread/channel ID)"
            exit 1
          fi

          echo "channel_id=$CHANNEL_ID" >> "$GITHUB_OUTPUT"

      - name: Delete messages via Discord API
        env:
          CHANNEL_ID: ${{ steps.resolve.outputs.channel_id }}
        run: |
          set -euo pipefail

          # Split comma-separated IDs into an array
          IFS=',' read -ra IDS <<< "$MESSAGE_IDS"

          if [ "${#IDS[@]}" -eq 0 ]; then
            echo "No message IDs provided."
            exit 1
          fi

          for RAW_ID in "${IDS[@]}"; do
            ID="$(echo "$RAW_ID" | xargs)"  # trim spaces

            if ! printf '%s\n' "$ID" | grep -Eq '^[0-9]{15,}$'; then
              echo "Skipping bad MESSAGE_ID: '$ID' (must be numeric Snowflake)"
              continue
            fi

            echo "â†’ Deleting message ID $ID in channel/thread $CHANNEL_ID"

            STATUS=$(curl -sS -X DELETE \
              -H "Authorization: Bot ${DISCORD_BOT_TOKEN}" \
              -H "Content-Type: application/json" \
              -o body.json -w "%{http_code}" \
              "https://discord.com/api/v10/channels/${CHANNEL_ID}/messages/${ID}")

            echo "HTTP $STATUS for $ID"
            if [ "$STATUS" != "204" ]; then
              echo "Response body:"
              cat body.json || true
            fi

            case "$STATUS" in
              204) echo "ðŸ—‘ï¸ Deleted message ${ID} in ${CHANNEL_ID}";;
              400) echo "âŒ 400 Bad Request for ${ID} â€” check this is the *thread* ID, not parent, and IDs are numeric." ;;
              403) echo "â›” 403 Forbidden for ${ID} â€” bot lacks permission (needs Manage Messages if it didnâ€™t author the message)." ;;
              404) echo "â“ 404 Not Found for ${ID} â€” wrong channel/thread or message already gone." ;;
              *)   echo "âš ï¸ Unexpected HTTP $STATUS for ${ID}";;
            esac

            echo "----"
          done
