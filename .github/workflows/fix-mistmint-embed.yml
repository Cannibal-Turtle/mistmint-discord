name: Fix Mistmint embed image (URL only, multi)

on:
  workflow_dispatch:

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: pip install requests

      - name: Update embed images to S3 URL
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
        run: |
          python - << 'PY'
          import os, json, requests

          BOT = f"Bot {os.environ['DISCORD_BOT_TOKEN']}"
          THREAD_ID  = "1434025746468311050"
          MSG_IDS    = [
            "1434082796908838986",
            "1434514466543767583",
          ]
          IMG = "https://web-novel-mistmint.s3.ap-southeast-1.amazonaws.com/novels/dd6947d3-dd7f-4c5b-a42c-aaba5363502b.png"

          base = "https://discord.com/api/v10"
          H = {"Authorization": BOT}

          # Join thread if needed (no-op if already in)
          r = requests.get(f"{base}/channels/{THREAD_ID}/thread-members/@me", headers=H, timeout=15)
          if r.status_code != 200:
              requests.put(f"{base}/channels/{THREAD_ID}/thread-members/@me", headers=H, timeout=15)

          def patch_message(mid: str):
              m = requests.get(f"{base}/channels/{THREAD_ID}/messages/{mid}", headers=H, timeout=15)
              m.raise_for_status()
              msg = m.json()

              embeds = msg.get("embeds") or [{}]
              e0 = dict(embeds[0])  # preserve existing fields
              e0["image"] = {"url": IMG}
              new_embeds = [e0] + embeds[1:]

              old_atts = [{"id": str(a["id"]), "filename": a["filename"]} for a in msg.get("attachments", [])]
              payload = {"embeds": new_embeds}
              if old_atts:
                  payload["attachments"] = old_atts

              r = requests.patch(
                  f"{base}/channels/{THREAD_ID}/messages/{mid}",
                  headers={**H, "Content-Type":"application/json"},
                  json=payload,
                  timeout=30
              )
              r.raise_for_status()
              print(f"âœ… Updated message {mid}")

          for mid in MSG_IDS:
              patch_message(mid)
          PY
