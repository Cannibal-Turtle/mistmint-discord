name: Fix Mistmint embed image (URL only)

on:
  workflow_dispatch:

jobs:
  patch:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Update embed image to S3 URL
        env:
          DISCORD_BOT_TOKEN: ${{ secrets.DISCORD_BOT_TOKEN }}
        run: |
          python - << 'PY'
          import os, json, requests

          BOT = f"Bot {os.environ['DISCORD_BOT_TOKEN']}"
          THREAD_ID  = "1434025746468311050"
          MESSAGE_ID = "1434079266806435954"
          IMG = "https://web-novel-mistmint.s3.ap-southeast-1.amazonaws.com/novels/dd6947d3-dd7f-4c5b-a42c-aaba5363502b.png"

          base = "https://discord.com/api/v10"
          H = {"Authorization": BOT}

          # Join thread if needed (safe no-op if already joined)
          r = requests.get(f"{base}/channels/{THREAD_ID}/thread-members/@me", headers=H, timeout=15)
          if r.status_code != 200:
              requests.put(f"{base}/channels/{THREAD_ID}/thread-members/@me", headers=H, timeout=15)

          # Get the message so we preserve existing fields
          m = requests.get(f"{base}/channels/{THREAD_ID}/messages/{MESSAGE_ID}", headers=H, timeout=15)
          m.raise_for_status()
          msg = m.json()

          embeds = msg.get("embeds") or [{}]
          e0 = dict(embeds[0])  # keep title/url/description/footer/etc.
          e0["image"] = {"url": IMG}
          new_embeds = [e0] + embeds[1:]  # if there were multiple embeds

          # Keep any existing attachments (if present)
          old_atts = [{"id": str(a["id"]), "filename": a["filename"]} for a in msg.get("attachments", [])]
          payload = {"embeds": new_embeds}
          if old_atts:
              payload["attachments"] = old_atts

          r = requests.patch(
              f"{base}/channels/{THREAD_ID}/messages/{MESSAGE_ID}",
              headers={**H, "Content-Type":"application/json"},
              json=payload,
              timeout=30
          )
          r.raise_for_status()
          print("âœ… Embed image updated to S3 URL")
          PY
